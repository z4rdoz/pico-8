pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- global variables
t = 0
last_bullet = 3 
---------------------

-- pseudo-classes
function new_cbox(x1, y1, x2, y2)
	local c = {
		x1 = x1,
		y1 = y1,
		x2 = x2,
		y2 = y2		
	}
	return c
end

function new_player()
	local p = {
		health = 100
	}
	return p
end

function new_enemy(x,y)
	local e = {
		sp = 17,
		init_x = x,
		init_y = y,
		x = x,
		y = y,
		r = 10,
		box = new_cbox(0, 0, 7, 7),
	 update=function(self)
			self.x = self.init_x +
				(sin(t/50) * self.r)
			self.y = self.init_y +
				(cos(t/50) * self.r)
	 end	 
 	}
 return e
end

function new_ship(x, y)
	local s = {		
		sp = 1,
		x = x,
		y = y,
		has_shield = true,
		box = new_cbox(0, 2, 7, 5),
		update = function(self)
			if (t%6<3) then
				ship.sp = 1
			else
				ship.sp = 2
			end
		end
		}
	return s
end

function new_bullet()
	local b = {		
		x = ship.x,
		y = ship.y,		
		dx = 0,
		dy = -3,			
		update=function(self)
			self.x += self.dx
			self.y += self.dy
			if is_offscreen(self.x,self.y) then
				del(bullets,self)
			end
		end	
	}
	if last_bullet == 3 then
		b.sp = 4
		b.box = new_cbox(0, 0, 0, 1)
	else
		b.sp = 3
		b.box = new_cbox(7, 0, 7, 1)
	end
	last_bullet = b.sp
	return b
end

function new_space_particle()

end
--------------------

-- core functions
function fire()
	b = new_bullet()
	add(bullets,b)
end

function get_collision_box(s)
	local sbox = {
		x = s.x + s.box.x1,
		y = s.y + s.box.y1,
		width = s.box.x2 - s.box.x1,
		height = s.box.y2 - s.box.y1,
	}
	return sbox
end

function collides_with(s1, s2)
	local a = get_collision_box(s1)
	local b = get_collision_box(s2)
	return (abs(a.x - b.x) * 2 < (a.width + b.width)) and
         (abs(a.y - b.y) * 2 < (a.height + b.height))
end

--------------------

-- helper functions
function is_offscreen(x,y,how_far)
	local offscreen = {0,128}
	if (how_far) then
		offscreen[2] += how_far
		offscreen[1] -= how_far
	end
	if x < offscreen[1] or x > offscreen[2]
		or y < offscreen[1] or y > offscreen[2] then
		return true
	end
	return false
end

function ceil(x)
	return -flr(-x)
end
--------------------

-- system functions
function _init()
	ship = new_ship(60,60)
	player = new_player()
	bullets = {}
	enemies = {}
	for i=1,10 do		
		add(enemies, 
			new_enemy(i*16,30-i*8))
	end
end

function _update()
	t+=1
	
	ship:update()
	
	for b in all(bullets) do
		b:update()
	end
	
	for e in all(enemies) do
		e:update()
	end
	
	if btn(0) then ship.x -= 1 end
	if btn(1) then ship.x += 1 end
	if btn(2) then ship.y -= 1 end
	if btn(3) then ship.y += 1 end
	if btnp(4) then fire() end
end

function _draw()
	cls()
	palt()

	print(stat(1),0,0,7)

	spr(ship.sp,ship.x,ship.y)

	for b in all(bullets) do
		spr(b.sp,b.x,b.y)
	end
	
	collisions = 0
	
	for e in all(enemies) do
		spr(e.sp,e.x,e.y)
		for b in all(bullets) do
			if collides_with(e, b) then
				del(enemies, e)
			end
		end
	end

	if ship.has_shield then
		spr(20, ship.x-4, ship.y-3, 2, 2)
	end

	--health
 	palt(11,true)
 	palt(0,false)
	
	spr(5,5,5,3,1)
	local h = player.health*22/100	
  
 
	for i = 1,h do
		line(i+5,6,i+5,7, 8)
	end 
end
--------------------

__gfx__
0000000000000000000000000000000aa0000000b6666666666666666666666b0000000000000000000000000000000000000000000000000000000000000000
0000000000011000000110000000000aa00000006000000000000000000000060000000000000000000000000000000000000000000000000000000000000000
00700700c0acca0cc0acca0c00000000000000006000000000000000000000060000000000000000000000000000000000000000000000000000000000000000
00077000c01cc10cc01cc10c0000000000000000b6666666666666666666666b0000000000000000000000000000000000000000000000000000000000000000
00077000cc1cc1cccc1cc1cc0000000000000000bbbbbbbbbbbbbbbbbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000
0070070011188111111881110000000000000000bbbbbbbbbbbbbbbbbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000
00000000001a01000010a1000000000000000000bbbbbbbbbbbbbbbbbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000
000000000000a000000a00000000000000000000bbbbbbbbbbbbbbbbbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000
00000000023333203233332002333323000008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000322332233323322332233233000080000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000033a33a3333333a3333a33333000800000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b333333bb333333bb333333b008000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b3b33b3bb3b33b3bb3b33b3b080000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b0b33b0bb0b3333bb3333b0b080000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b0b00b0bb0b00b3bb3b00b0b080000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000b00b0000b00b0000b00b00080000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000080000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000080000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000008000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000800000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000080000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000
